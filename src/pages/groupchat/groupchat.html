<ion-header>
  <ion-navbar color="hcolor" text-center>
    <ion-title>
      <span *ngIf="!meingroup">Connexion...</span>
      <span *ngIf="meingroup"> {{groupdisplayname}}</span>
    </ion-title>
    <small style="color:beige;" *ngIf="meingroup">
      <i *ngIf="groupnberofmembers>15">{{groupnberofmembers}} participants</i>
      <i *ngIf="!groupnberofmembers||groupnberofmembers<=15">Groupe de discussion</i>
    </small>
    <ion-buttons end *ngIf="meingroup">
      <button ion-button icon-only (click)="openGroupeSetting()">
        <ion-icon name="md-options"></ion-icon>
      </button>
    </ion-buttons>
  </ion-navbar>
</ion-header>
<ion-content class="bg-white" hide-fab>
  <ion-item *ngIf="(!sendToAdmin&&!meingroup)&&!isExpired(abonnement)" class="send-message" text-wrap no-border>
    <ion-icon name="person" item-left></ion-icon>
    <p>Vous ne pouvez plus échanger dans cette discussion car vous avez quitté le groupe.</p>
  </ion-item>
  <ion-item *ngIf="(sendToAdmin||!meingroup)&&!isExpired(abonnement)" class="send-message" text-wrap no-border>
    <ion-icon name="person" item-left></ion-icon>
    <p>Vous écrivez à un responsable enseignant. Les autres participants ne verront pas ce message.</p>
  </ion-item>
  <ion-item *ngIf="(sendToAdmin||!meingroup)&&isExpired(abonnement)" class="send-message" text-wrap>
    <ion-icon name="ios-alert" color="danger" item-left></ion-icon>
    <p>Votre inscription au programme est arrivée à expiration et vous n'avez plus accès à certaines fonctionnalités de ce groupe.
      Vous ne pouvez plus parler directement à un enseignant, recevoir leur message, et bien d'autres.
    </p>
  </ion-item>
  <ion-item *ngIf="meingroup&&meingroup.blocked" class="send-message" text-wrap no-border>
    <ion-icon name="md-alert" color="danger" item-left></ion-icon>
    <p>Vous êtes bloqué et ne pouvez plus participer aux discussions dans ce groupe. Le blockage survient si vos pratiques vont
      à l'encontre des règle chez centor. Vous pouvez être bloqué si vous utilisez des expressions liées à la violence, à
      la dégradation de la personne humaine, ou à des substances interdites.
    </p>
  </ion-item>
<ion-infinite-scroll (ionInfinite)="doInfinite($event)" position='top' *ngIf="showInfinite">
    <ion-infinite-scroll-content></ion-infinite-scroll-content>
  </ion-infinite-scroll>
  <div class="message-wrap">
    <div *ngFor="let item of allgroupmsgs" class="message-wrapper message-wrap">
      <div *ngIf="item&&item.message&&item.message.fromAdmin" (press)="presentSheet(item.message)">
        <img class="profile-pic left" [src]="item.photoURL" />
        <!--  wave-->
        <div class="chat-bubble admin slide-left">
          <a  *ngIf="item.message&&item.message.fileurl" no-lines [href]="item.message.fileurl">
            <img [src]="_DomSanitizer.bypassSecurityTrustUrl(item.message.fileurl)" *ngIf="item.message&&item.message.type=='image'">
          </a>
          <question-view *ngIf="item.message&&item.message.type=='question'" [question]="item.message.question"></question-view>
          <ion-list *ngIf="item.message&&item.message.type=='ressource'">
            <ion-row *ngIf="item.message.ressource" text-wrap no-margin>
              <ion-col col-4>
                <ion-thumbnail item-left>
                  <img src="assets/images/file-image.png">
                </ion-thumbnail>
              </ion-col>
              <ion-col col-8>
                <h4>{{item.message.ressource.nom}}</h4>
              </ion-col>
            </ion-row>
            <div *ngIf="item.message.ressource"text-wrap no-lines>
              <p>{{item.message.ressource.description}}</p>
            </div>
            <div *ngIf="item.message.ressource" ion-item no-lines class="view">
              <button small ion-button color="primary" outline (click)="openRessource(item.message.ressource)" item-right>Consulter</button>
            </div>
          </ion-list>
          <p *ngIf="item.message&&item.message.ref">
            <strong>{{item.message.ref}}</strong>
          </p>
          <div class="message" [MathJax]="item.message.text" autolinker>
          </div>
          <div class="message-detail">
            <span class="bold">{{item.displayName| limitTo:15}}</span>,
            <small *ngIf="item" item-right>&nbsp;&nbsp;&nbsp;{{item.timestamp| relativeTime}}</small>
          </div>
        </div>
      </div>
      <div *ngIf="item&&item.message&&(item.sentby != alignuid)&&!item.message.fromAdmin" (press)="presentSheet(item.message)">
        <img class="profile-pic left" [src]="item.photoURL" />
        <!--  wave-->
        <div class="chat-bubble left slide-left">
          <a  *ngIf="item.message&&item.message.fileurl" no-lines [href]="item.message.fileurl">
            <img [src]="_DomSanitizer.bypassSecurityTrustUrl(item.message.fileurl)" *ngIf="item.message&&item.message.type=='image'">
          </a>
          <question-view *ngIf="item.message&&item.message.type=='question'" [question]="item.message.question"></question-view>
          <ion-list *ngIf="item.message&&item.message.type=='ressource'">
            <ion-row *ngIf="item.message.ressource" text-wrap no-margin>
              <ion-col col-4>
                <ion-thumbnail item-left>
                     <img src="assets/images/file-image.png">
                   </ion-thumbnail>
              </ion-col>
              <ion-col col-8><h4>{{item.message.ressource.nom}}</h4></ion-col>          
            </ion-row>
            <div *ngIf="item.message.ressource" text-wrap no-lines>
              <p>{{item.message.ressource.description}}</p>
            </div>
            <div *ngIf="item.message.ressource" ion-item no-lines class="view">
              <button ion-button small color="primary" outline (click)="openRessource(item.message.ressource)" item-right>Consulter</button>
            </div>
          </ion-list>
          <p *ngIf="item.message&&item.message.ref">
            <strong>{{item.message.ref}}</strong>
          </p>
          <div class="message" [MathJax]="item.message.text" autolinker>
          </div>
          <div class="message-detail">
            <span class="bold">{{item.displayName| limitTo:15}}</span>,
            <small *ngIf="item" item-right>&nbsp;&nbsp;&nbsp;{{item.timestamp| relativeTime}}</small>
          </div>
        </div>
      </div>
      <div *ngIf="item&&item.sentby===alignuid" (press)="presentSheet(item.message)">
        <img class="profile-pic right" [src]="photoURL" />
        <div class="chat-bubble right slide-right">
          <a  *ngIf="item.message&&item.message.fileurl" no-lines [href]="item.message.fileurl">
            <img [src]="_DomSanitizer.bypassSecurityTrustUrl(item.message.fileurl)" *ngIf="item.message&&item.message.type=='image'">
            
          </a>
          <question-view *ngIf="item.message&&item.message.type=='question'" [question]="item.message.question"></question-view>
          <ion-list  *ngIf="item.message&&item.message.type=='ressource'">
            <ion-row *ngIf="item.message.ressource" text-wrap no-margin>
              <ion-col col-4>
                <ion-thumbnail item-left>
                  <img src="assets/images/file-image.png">
                </ion-thumbnail>
              </ion-col>
              <ion-col col-8>
                <h4>{{item.message.ressource.nom}}</h4>
              </ion-col>
            </ion-row>
          <div *ngIf="item.message.ressource" text-wrap no-lines>
            <p>{{item.message.ressource.description}}</p>
          </div>
          <div *ngIf="item.message.ressource" ion-item no-lines class="view">
            <button small ion-button color="primary" outline (click)="openRessource(item.message.ressource)" item-right>Consulter</button>
          </div>
          </ion-list>
          <p *ngIf="item.message&&item.message.ref">
            <strong>{{item.message.ref}}</strong>
          </p>
          <div class="message" *ngIf="item.message" [MathJax]="item.message.text" autolinker>
          </div>
          <div class="message-detail">
            <span class="bold">Moi</span>,
            <small *ngIf="item" item-right>&nbsp;&nbsp;&nbsp;{{item.timestamp| relativeTime}}</small>
          </div>
        </div>
      </div>
      <div class="cf"></div>
    </div>
  </div>
  <ion-item class="file-preview" *ngIf="fileurl">
    <ion-thumbnail item-left *ngIf="mesagetype=='image'">
      <img [src]="_DomSanitizer.bypassSecurityTrustUrl(fileurl)">
    </ion-thumbnail>
    <span *ngIf="mesagetype=='image'">Image</span>
    <p>Saisir une legende </p>
    <button ion-button item-right clear icon-only (click)="cancelFile()" item-right class="button-close">
      <ion-icon name="ios-close-circle-outline"></ion-icon>
    </button>
  </ion-item>
<ion-fab bottom right  #fab>
  <button ion-fab mini color="light" (click)="scrollto()" ><ion-icon name="ios-arrow-down-outline"></ion-icon></button>
</ion-fab>
</ion-content>
<ion-footer no-border [style.height]="showEmojiPicker ? '255px' : '55px'">
  <ion-grid class="input-wrap" no-border>
    <ion-row>
      <ion-col col-1>
        <button ion-button small clear icon-only item-right (click)="switchEmojiPicker()">
          <ion-icon name="md-happy"></ion-icon>
        </button>
      </ion-col>
      <ion-col col-1>
        <button ion-button clear small icon-only item-right (click)="toggleDest()" *ngIf="sendToAdmin">
          <ion-icon name="ios-chatboxes"></ion-icon>
        </button>
        <button ion-button clear small icon-only item-right (click)="toggleDest()" *ngIf="!sendToAdmin">
          <ion-icon name="ios-chatboxes-outline"></ion-icon>
        </button>
      </ion-col>
      <ion-col col-8>
        <ion-textarea #chat_input placeholder="Saisir un message" [(ngModel)]="newmessage" (keyup.enter)="addgroupmsg()" (ionFocus)="onFocus()"
          autosize>
        </ion-textarea>
      </ion-col>
      <ion-col col-2>
        <button ion-button clear icon-only item-right (click)="addgroupmsg()" [hidden]="(!newmessage&&!fileurl)" [disabled]="!sendToAdmin&&!meingroup">
          <ion-icon name="ios-send" ios="ios-send" md="md-send"></ion-icon>
        </button>
        <button ion-button clear icon-only item-right (click)="presentSheetSendFile()" [hidden]="!(!newmessage&&!fileurl)">
          <ion-icon name="ios-send" ios="ios-attach" md="md-attach"></ion-icon>
        </button>
      </ion-col>
    </ion-row>
  </ion-grid>
  <emoji-picker *ngIf="showEmojiPicker" [(ngModel)]="newmessage"></emoji-picker>
</ion-footer>